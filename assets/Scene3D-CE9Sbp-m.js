import{l as ue,a as mt,u as Ve,U as qe,b as Ge,c as je,d as $e,s as st,e as pt,f as pn,g as hn,h as Tt,p as rn,i as Fn,j as kn,k as zn,m as Pn,n as Nn,o as Ue,q as Cn,r as An,t as Dn,v as Tn,w as Ln,G as In,x as Wn,_ as sn}from"./index-Csx-3m5H.js";import{r,j as t,c as On}from"./react-core-gSd2dSvh.js";import{ar as on,av as Un,as as Bn,at as Yn,_ as Vn,D as Be,B as an,x as Ne,y as cn,E as ln,aW as dt,aE as _n,V as F,a as qn,aF as Gn,aG as $n,aH as Hn,aI as Xn}from"./three-core-CxdX34lx.js";import{C as Qn,E as Zn,R as Jn,U as Kn,a as er,c as tr}from"./three-addons-C-m5gQIz.js";import{E as nr,g as rr}from"./ui-core-B-1TAk4_.js";import"./vendor-DD4buw6u.js";class At{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,un.unregister(this),e}free(){const e=this.__destroy_into_raw();h.__wbg_cubesimulation_free(e,0)}get_face_matrices_ptr(){return h.cubesimulation_get_face_matrices_ptr(this.__wbg_ptr)>>>0}get_face_opacities_ptr(){return h.cubesimulation_get_face_opacities_ptr(this.__wbg_ptr)>>>0}constructor(e,s,o,l){const i=Ye(e,h.__wbindgen_malloc),u=Le,a=Ye(s,h.__wbindgen_malloc),f=Le,d=Ye(o,h.__wbindgen_malloc),m=Le,k=Ye(l,h.__wbindgen_malloc),_=Le,M=h.cubesimulation_new(i,u,a,f,d,m,k,_);return this.__wbg_ptr=M>>>0,un.register(this,this.__wbg_ptr,this),this}update(e,s,o,l,i,u,a,f,d,m){const k=Ye(f,h.__wbindgen_malloc),_=Le,M=Ye(d,h.__wbindgen_malloc),E=Le;h.cubesimulation_update(this.__wbg_ptr,e,s,o,l,i,u,a,k,_,M,E,m)}get burst(){return h.__wbg_get_cubesimulation_burst(this.__wbg_ptr)}get flight_envelope(){return h.__wbg_get_cubesimulation_flight_envelope(this.__wbg_ptr)}get flight_swirl(){return h.__wbg_get_cubesimulation_flight_swirl(this.__wbg_ptr)}get rotation_x(){return h.__wbg_get_cubesimulation_rotation_x(this.__wbg_ptr)}get rotation_y(){return h.__wbg_get_cubesimulation_rotation_y(this.__wbg_ptr)}get velocity_x(){return h.__wbg_get_cubesimulation_velocity_x(this.__wbg_ptr)}get velocity_y(){return h.__wbg_get_cubesimulation_velocity_y(this.__wbg_ptr)}set burst(e){h.__wbg_set_cubesimulation_burst(this.__wbg_ptr,e)}set flight_envelope(e){h.__wbg_set_cubesimulation_flight_envelope(this.__wbg_ptr,e)}set flight_swirl(e){h.__wbg_set_cubesimulation_flight_swirl(this.__wbg_ptr,e)}set rotation_x(e){h.__wbg_set_cubesimulation_rotation_x(this.__wbg_ptr,e)}set rotation_y(e){h.__wbg_set_cubesimulation_rotation_y(this.__wbg_ptr,e)}set velocity_x(e){h.__wbg_set_cubesimulation_velocity_x(this.__wbg_ptr,e)}set velocity_y(e){h.__wbg_set_cubesimulation_velocity_y(this.__wbg_ptr,e)}}Symbol.dispose&&(At.prototype[Symbol.dispose]=At.prototype.free);class Dt{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,dn.unregister(this),e}free(){const e=this.__destroy_into_raw();h.__wbg_starsimulation_free(e,0)}get_matrices_ptr(){return h.starsimulation_get_matrices_ptr(this.__wbg_ptr)>>>0}get_positions_ptr(){return h.cubesimulation_get_face_opacities_ptr(this.__wbg_ptr)>>>0}constructor(e,s){const o=h.starsimulation_new(e,s);return this.__wbg_ptr=o>>>0,dn.register(this,this.__wbg_ptr,this),this}update(e,s,o){h.starsimulation_update(this.__wbg_ptr,e,s,o)}}Symbol.dispose&&(Dt.prototype[Symbol.dispose]=Dt.prototype.free);function sr(){return{__proto__:null,"./dust_wasm_bg.js":{__proto__:null,__wbg___wbindgen_throw_be289d5034ed271b:function(e,s){throw new Error(ir(e,s))},__wbg_random_912284dbf636f269:function(){return Math.random()},__wbindgen_init_externref_table:function(){const e=h.__wbindgen_externrefs,s=e.grow(4);e.set(0,void 0),e.set(s+0,void 0),e.set(s+1,null),e.set(s+2,!0),e.set(s+3,!1)}}}}const un=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>h.__wbg_cubesimulation_free(n>>>0,1));typeof FinalizationRegistry>"u"||new FinalizationRegistry(n=>h.__wbg_dustsimulation_free(n>>>0,1));typeof FinalizationRegistry>"u"||new FinalizationRegistry(n=>h.__wbg_noisegenerator_free(n>>>0,1));const dn=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>h.__wbg_starsimulation_free(n>>>0,1));let nt=null;function or(){return(nt===null||nt.byteLength===0)&&(nt=new Float32Array(h.memory.buffer)),nt}function ir(n,e){return n=n>>>0,lr(n,e)}let rt=null;function ar(){return(rt===null||rt.byteLength===0)&&(rt=new Uint8Array(h.memory.buffer)),rt}function Ye(n,e){const s=e(n.length*4,4)>>>0;return or().set(n,s/4),Le=n.length,s}let ft=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});ft.decode();const cr=2146435072;let Nt=0;function lr(n,e){return Nt+=e,Nt>=cr&&(ft=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),ft.decode(),Nt=e),ft.decode(ar().subarray(n,n+e))}let Le=0,h;function ur(n,e){return h=n.exports,nt=null,rt=null,h.__wbindgen_start(),h}async function dr(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(l){if(n.ok&&s(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",l);else throw l}const o=await n.arrayBuffer();return await WebAssembly.instantiate(o,e)}else{const o=await WebAssembly.instantiate(n,e);return o instanceof WebAssembly.Instance?{instance:o,module:n}:o}function s(o){switch(o){case"basic":case"cors":case"default":return!0}return!1}}async function fr(n){if(h!==void 0)return h;n!==void 0&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),n===void 0&&(n=new URL(""+new URL("dust_wasm_bg-BIgFB5Tf.wasm",import.meta.url).href,import.meta.url));const e=sr();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:s,module:o}=await dr(await n,e);return ur(s)}function mr({pixelRatio:n,isPhone:e,isTablet:s,containerRef:o,webglContainerRef:l}){const i=r.useRef(null),u=r.useRef(null),a=r.useRef(null),f=r.useRef(null),d=r.useRef(null),[m,k]=r.useState(!1);return r.useEffect(()=>{if(!o.current||!l.current)return;const _=window.innerWidth,M=window.innerHeight,E=new on,v=new on;i.current=E,u.current=v;const S=new Un(50,_/M,1,5e3);S.position.z=e?1250:s?1400:1500,a.current=S;const p=new Qn;p.setSize(_,M),o.current.appendChild(p.domElement),f.current=p;let c=null,A=null,z=null;try{c=new Bn({antialias:!0,alpha:!0,powerPreference:"high-performance"}),c.setSize(_,M),c.setPixelRatio(Math.min(window.devicePixelRatio,n)),c.outputColorSpace=Yn,c.toneMapping=Vn,c.toneMappingExposure=1.08,c.setClearColor(0,0),l.current.appendChild(c.domElement),d.current=c;const N=c.domElement;A=$=>{$.preventDefault(),ue("error","useSceneInit","WebGL context lost")},z=()=>{c&&(c.setSize(window.innerWidth,window.innerHeight),c.setPixelRatio(Math.min(window.devicePixelRatio,n)),ue("info","useSceneInit","WebGL context restored"))},N.addEventListener("webglcontextlost",A,!1),N.addEventListener("webglcontextrestored",z,!1)}catch(N){d.current=null,ue("error","useSceneInit","WebGL initialization failed, running CSS3D only",{error:N instanceof Error?N.message:String(N)})}const D=o.current,y=l.current;return k(!0),()=>{k(!1),D&&p.domElement.parentNode===D&&D.removeChild(p.domElement),c&&y&&c.domElement.parentNode===y&&(A&&c.domElement.removeEventListener("webglcontextlost",A),z&&c.domElement.removeEventListener("webglcontextrestored",z),y.removeChild(c.domElement)),c?.dispose(),ue("info","useSceneInit","Scene resources disposed")}},[n,e,s,o,l]),r.useEffect(()=>{if(!m||!a.current||!f.current)return;const _=()=>{const M=window.innerWidth,E=window.innerHeight;a.current.aspect=M/E,a.current.updateProjectionMatrix(),f.current.setSize(M,E),d.current?.setSize(M,E),d.current?.setPixelRatio(Math.min(window.devicePixelRatio,n)),ue("info","useSceneInit","Scene resized",{width:M,height:E})};return window.addEventListener("resize",_),()=>window.removeEventListener("resize",_)},[m,n]),{sceneRef:i,webglSceneRef:u,cameraRef:a,cssRendererRef:f,webglRendererRef:d,initialized:m}}const fn=1;function pr({sceneRef:n,lowPowerMode:e,initialized:s,enabled:o=!0}){const l=r.useRef(null),i=r.useRef(null),u=r.useRef(null),a=r.useRef(null),f=r.useRef([]),d=r.useRef([]),m=r.useRef(null),k=r.useRef(0),_=r.useRef(0),M=r.useRef(0),E=r.useRef({starDensity:1,starTwinkle:1});return r.useEffect(()=>{const p=n.current;if(!o||!p||!s)return;const c=Math.floor((e?3400:8600)*fn),A=e?8200:11800,z=new Float32Array(c*3),D=new Float32Array(c*3),y=new Float32Array(c),N=new Float32Array(c),$=[new Be(8952234),new Be(13421772),new Be(13934698),new Be(10070715),new Be(12290201),new Be(8956569)];for(let Y=0;Y<c;Y+=1){const O=Y*3,te=Math.acos(2*Math.random()-1),fe=Math.random()*Math.PI*2,he=A*(.28+Math.pow(Math.random(),1.75)*.72);z[O]=he*Math.sin(te)*Math.cos(fe),z[O+1]=he*Math.sin(te)*Math.sin(fe)*.72,z[O+2]=he*Math.cos(te);const _e=$[Math.random()*$.length|0].clone();_e.multiplyScalar(.25+Math.random()*.35),D[O]=_e.r,D[O+1]=_e.g,D[O+2]=_e.b,y[Y]=e?1.3+Math.random()*2.1:1.5+Math.random()*2.9,N[Y]=Math.random()*Math.PI*2}const g=new an;g.setAttribute("position",new Ne(z,3)),g.setAttribute("color",new Ne(D,3)),g.setAttribute("size",new Ne(y,1)),g.setAttribute("twinkle",new Ne(N,1)),g.setDrawRange(0,c),d.current.push(g);const C=`
      attribute float size;
      attribute float twinkle;
      varying vec3 vColor;
      varying float vPulse;
      uniform float uTime;
      uniform float uPixelRatio;
      uniform float uTwinkleStrength;
      uniform float uSizeBoost;

      void main() {
        vColor = color;
        vPulse = mix(1.0, 0.45 + 0.55 * (sin(uTime * 2.2 + twinkle) * 0.5 + 0.5), uTwinkleStrength);
        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
        float distanceFade = clamp(320.0 / max(-mvPosition.z, 0.001), 0.45, 2.0);
        gl_PointSize = size * uPixelRatio * uSizeBoost * distanceFade;
        gl_Position = projectionMatrix * mvPosition;
      }
    `,H=`
      varying vec3 vColor;
      varying float vPulse;

      void main() {
        vec2 c = gl_PointCoord - vec2(0.5);
        float dist = length(c);
        if (dist > 0.5) discard;
        float core = smoothstep(0.23, 0.0, dist);
        float halo = smoothstep(0.5, 0.12, dist) * 0.28;
        float alpha = clamp((core + halo) * vPulse, 0.0, 1.0);
        gl_FragColor = vec4(vColor, alpha);
      }
    `,ae=new cn({uniforms:{uTime:{value:0},uPixelRatio:{value:Math.min(window.devicePixelRatio||1,1.8)},uTwinkleStrength:{value:1},uSizeBoost:{value:e?1.45:1.8}},vertexShader:C,fragmentShader:H,transparent:!0,depthWrite:!1,blending:ln,vertexColors:!0});f.current.push(ae),u.current=ae;const J=new dt(g,ae);J.frustumCulled=!1,p.add(J),l.current=J,k.current=c;const R=Math.floor((e?1700:4200)*fn),L=e?2e3:2900,G=new Float32Array(R*3),B=new Float32Array(R*3),b=new Float32Array(R),X=new Float32Array(R*3),ee=new Float32Array(R);for(let Y=0;Y<R;Y+=1){const O=Y*3;G[O]=(Math.random()-.5)*L*2,G[O+1]=(Math.random()-.5)*L*2,G[O+2]=(Math.random()-.5)*L*2;const te=$[Math.random()*$.length|0].clone();te.multiplyScalar(.28+Math.random()*.35),B[O]=te.r,B[O+1]=te.g,B[O+2]=te.b,b[Y]=(e?1.8:2.6)*(.55+Math.random()*1.15),ee[Y]=Math.random()*Math.PI*2,X[O]=(Math.random()-.5)*(e?.22:.46),X[O+1]=(Math.random()-.5)*(e?.22:.42),X[O+2]=(Math.random()-.5)*(e?.26:.52)}const x=new an;x.setAttribute("position",new Ne(G,3)),x.setAttribute("color",new Ne(B,3)),x.setAttribute("size",new Ne(b,1)),x.setAttribute("twinkle",new Ne(ee,1)),x.setDrawRange(0,R),d.current.push(x);const ht=`
      attribute float size;
      attribute float twinkle;
      varying vec3 vColor;
      varying float vPulse;
      varying float vDepth;
      uniform float uTime;
      uniform float uSizeMultiplier;
      uniform float uPixelRatio;
      uniform float uTwinkleStrength;

      void main() {
        vColor = color;
        vPulse = mix(1.0, 0.45 + 0.55 * (sin(uTime * 2.8 + twinkle) * 0.5 + 0.5), uTwinkleStrength);
        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
        vDepth = max(-mvPosition.z, 0.001);
        gl_PointSize = size * uPixelRatio * uSizeMultiplier * (300.0 / vDepth);
        gl_Position = projectionMatrix * mvPosition;
      }
    `,_t=`
      varying vec3 vColor;
      varying float vPulse;
      varying float vDepth;

      void main() {
        vec2 c = gl_PointCoord - vec2(0.5);
        float dist = length(c);
        if (dist > 0.5) discard;
        float core = smoothstep(0.2, 0.0, dist);
        float halo = smoothstep(0.5, 0.14, dist) * 0.34;
        float depthFade = smoothstep(0.0, 2200.0, vDepth);
        float alpha = clamp((core + halo) * vPulse * mix(1.0, 0.58, depthFade), 0.0, 1.0);
        gl_FragColor = vec4(vColor, alpha);
      }
    `,He=new cn({uniforms:{uTime:{value:0},uSizeMultiplier:{value:e?2.45:3.15},uPixelRatio:{value:Math.min(window.devicePixelRatio||1,1.8)},uTwinkleStrength:{value:1}},vertexShader:ht,fragmentShader:_t,transparent:!0,blending:ln,depthWrite:!1,vertexColors:!0});f.current.push(He),a.current=He;const Ce=new dt(x,He);Ce.frustumCulled=!1;const Ae=new _n;return Ae.add(Ce),p.add(Ae),i.current=Ae,_.current=R,m.current={velocities:X,range:L,count:R},mt("scene.starfield.ready",{deepStars:c,particles:R,lowPowerMode:e}),()=>{p.remove(J),p.remove(Ae),f.current.forEach(Y=>Y.dispose()),d.current.forEach(Y=>Y.dispose()),f.current=[],d.current=[],l.current=null,i.current=null,u.current=null,a.current=null,m.current=null,k.current=0,_.current=0}},[o,n,e,s]),{updateStarField:(p,c,A=0,z=0,D,y)=>{if(!o||!l.current||!i.current||!m.current||!Number.isFinite(p)||p<=0)return;const N=Math.min(.2,Math.max(1/240,p));M.current+=N;const $=Math.min(3,Math.max(.35,N*60)),g=Number.isFinite(z)?z:0,C=Math.min(1.7,g/(e?1500:1900)),H=l.current;H.rotation.y+=N*((e?.006:.011)+C*.018),H.rotation.x+=N*(e?.0014:.0022),u.current&&(u.current.uniforms.uTime.value=M.current,u.current.uniforms.uPixelRatio.value=Math.min(window.devicePixelRatio||1,1.8));const ae=i.current;Number.isFinite(c.x)&&Number.isFinite(c.y)&&Number.isFinite(c.z)?ae.position.set(c.x,c.y,c.z):ue("warn","scene.starfield","Invalid camera position for starfield update",c);const{velocities:J,range:R,count:L}=m.current,G=ae.children[0];if(!(G instanceof dt))return;const B=G.geometry,b=B.attributes.position.array;if(D&&y){const X=D.get_positions_ptr(),ee=new Float32Array(y.buffer,X,L*3);b.set(ee)}else{const X=(e?1.2:1.95)+A*(e?2:3.9)+C*3.35;for(let ee=0;ee<L;ee+=1){const x=ee*3;b[x]+=J[x]*(1+C*.5)*$,b[x+1]+=J[x+1]*(1+C*.4)*$,b[x+2]+=(J[x+2]+X)*$,(!Number.isFinite(b[x])||!Number.isFinite(b[x+1])||!Number.isFinite(b[x+2]))&&(b[x]=(Math.random()-.5)*R*2,b[x+1]=(Math.random()-.5)*R*2,b[x+2]=(Math.random()-.5)*R*2),b[x]>R&&(b[x]-=R*2),b[x]<-R&&(b[x]+=R*2),b[x+1]>R&&(b[x+1]-=R*2),b[x+1]<-R&&(b[x+1]+=R*2),b[x+2]>R&&(b[x+2]-=R*2),b[x+2]<-R&&(b[x+2]+=R*2)}}B.attributes.position.needsUpdate=!0,a.current&&(a.current.uniforms.uTime.value=M.current,a.current.uniforms.uPixelRatio.value=Math.min(window.devicePixelRatio||1,1.8),a.current.uniforms.uSizeMultiplier.value=(e?2.45:3.15)*(.82+E.current.starDensity*.25)+A*(e?.5:.9)+C*.95)},applyQuality:p=>{E.current=p;const c=l.current;if(c){const z=Math.max(200,Math.floor(k.current*p.starDensity));c.geometry.setDrawRange(0,z)}const A=i.current;if(A?.children[0]instanceof dt){const z=Math.max(120,Math.floor(_.current*p.starDensity));A.children[0].geometry.setDrawRange(0,z)}u.current&&(u.current.uniforms.uTwinkleStrength.value=Math.min(1.25,Math.max(.2,p.starTwinkle)),u.current.uniforms.uSizeBoost.value=(e?1.45:1.8)*(.9+p.starDensity*.22)),a.current&&(a.current.uniforms.uTwinkleStrength.value=Math.min(1.25,Math.max(.2,p.starTwinkle)),a.current.uniforms.uSizeMultiplier.value=(e?2.45:3.15)*(.82+p.starDensity*.25))}}}function hr({interactionTargetRef:n,minZoom:e,maxZoom:s,defaultCameraDistance:o,startAnimation:l}){const i=r.useRef({x:0,y:0}),u=r.useRef({x:0,y:0}),a=r.useRef({x:0,y:0}),f=r.useRef({x:0,y:0}),d=r.useRef(o),m=r.useRef(!1),k=r.useRef(!1),_=r.useRef({x:0,y:0}),M=r.useRef({x:0,y:0}),E=r.useRef({x:0,y:0}),v=r.useRef({active:!1,elapsed:0,duration:1.8,from:{x:0,y:0},to:{x:0,y:0}});return r.useEffect(()=>{const p=n.current;if(!p)return;const c=y=>{m.current=!0,ue("debug","scene3d-controls","Drag started",{x:y.clientX,y:y.clientY}),_.current={x:y.clientX,y:y.clientY},a.current={x:0,y:0},f.current={x:0,y:0},l()},A=y=>{if(m.current){const N=y.clientX-_.current.x,$=y.clientY-_.current.y,g=.0032,C=N*g,H=$*g;a.current.y=a.current.y*.7+C*.3,a.current.x=a.current.x*.7+H*.3,_.current={x:y.clientX,y:y.clientY},l()}},z=()=>{m.current=!1,f.current={...a.current},ue("debug","scene3d-controls","Drag ended")},D=y=>{y.preventDefault(),d.current+=y.deltaY*.5,d.current=Math.max(e,Math.min(s,d.current)),ue("debug","scene3d-controls","Zoom changed",{deltaY:y.deltaY,cameraZ:d.current}),l()};return p.addEventListener("mousedown",c),window.addEventListener("mousemove",A),window.addEventListener("mouseup",z),p.addEventListener("wheel",D,{passive:!1}),()=>{p.removeEventListener("mousedown",c),window.removeEventListener("mousemove",A),window.removeEventListener("mouseup",z),p.removeEventListener("wheel",D)}},[n,e,s,l]),{currentRotationRef:i,targetRotationRef:u,velocityRef:a,inertiaRef:f,userCameraDistanceRef:d,isDraggingRef:m,isTransitioningRef:k,updatePhysics:(p,c=1/60)=>{const A=Math.min(.05,Math.max(.004166666666666667,c)),z=A*60,D=C=>1-Math.pow(1-C,3),y=(C,H)=>Math.atan2(Math.sin(H-C),Math.cos(H-C));if(m.current)i.current.x+=a.current.x,i.current.y+=a.current.y,u.current={...i.current},v.current.active=!1,v.current.elapsed=0,E.current={...u.current},f.current={x:0,y:0},k.current=!1;else{const C=u.current,H=E.current,ae=C.x-H.x,J=y(H.y,C.y);if(Math.abs(ae)>8e-4||Math.abs(J)>8e-4){f.current={x:0,y:0};const L=Math.hypot(ae,J),G=Math.min(2.5,Math.max(1.5,1.4+L*.5));v.current={active:!0,elapsed:0,duration:G,from:{...i.current},to:{x:C.x,y:C.y}},E.current={...C}}if(v.current.active){v.current.elapsed+=A;const L=Math.min(1,v.current.elapsed/v.current.duration),G=D(L),B=v.current.from,b=v.current.to,X=y(B.y,b.y);i.current.x=B.x+(b.x-B.x)*G,i.current.y=B.y+X*G,L>=1&&(v.current.active=!1,i.current.x=b.x,i.current.y=b.y)}else{const L=f.current;if(Math.abs(L.x)+Math.abs(L.y)>(p?18e-5:12e-5)){i.current.x+=L.x*z,i.current.y+=L.y*z;const b=Math.pow(p?.86:.9,z);L.x*=b,L.y*=b,u.current={...i.current},E.current={...u.current}}else{f.current={x:0,y:0};const B=p?.08:.12,b=C.x-i.current.x,X=y(i.current.y,C.y);i.current.x+=b*B,i.current.y+=X*B}}k.current=v.current.active}i.current.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,i.current.x));const N=M.current,$=i.current.x-N.x,g=i.current.y-N.y;a.current.x=$,a.current.y=g,M.current={x:i.current.x,y:i.current.y}}}}new F(440,220,-520);new F(-560,-140,-680);new F;new F;new F;new F;function _r({targetRotation:n,minZoom:e,maxZoom:s,defaultCameraDistance:o,isPhone:l,lowPowerMode:i,prefersReducedMotion:u,startAnimation:a,lockCamera:f}){r.useRef(new F),r.useRef(new F),r.useRef(new F),r.useRef(new F),r.useRef(new F(0,0,s*.62)),r.useRef(0),r.useRef(!1);const d=r.useRef({active:!1,startMs:0,durationMs:4200,shotReady:!1,startCameraDistance:0,targetCameraDistance:0,phase:0,shotMode:"anchored",orbitPlanetIndex:0,lookPlanetIndex:1,orbitDirection:1,orbitTurns:1.45,orbitRadius:150,orbitLift:28,orbitScale:1.25}),m=r.useRef({active:!1,startMs:0,seed:0});return r.useEffect(()=>{{d.current.active=!1,m.current.active=!1,a();return}},[n,l,i,u,a,f]),{cameraFlightRef:d,rotationBurstRef:m,updateCameraFlight:(_,M,E,v,S=1)=>{{const p=new F(0,E*.55,0);return v.lerp(p,.2),{cameraDistance:o,cameraYaw:0,cameraPitch:0,cameraRoll:0,flightEnvelope:0,flightSwirl:0,burst:0,cameraOverridePosition:null,lookAtOverride:null}}}}}const Ct=["ultra","high","medium","low"],gr={ultra:{pixelRatioScale:1,starDensity:1,starTwinkle:1,blackHoleDetail:1,motionScale:1},high:{pixelRatioScale:.9,starDensity:.86,starTwinkle:.88,blackHoleDetail:.86,motionScale:.92},medium:{pixelRatioScale:.78,starDensity:.7,starTwinkle:.72,blackHoleDetail:.68,motionScale:.82},low:{pixelRatioScale:.66,starDensity:.54,starTwinkle:.58,blackHoleDetail:.52,motionScale:.72}};function mn(n,e){const s=Ct.indexOf(n);if(s===-1)return n;const o=Math.max(0,Math.min(Ct.length-1,s+e));return Ct[o]}function wr({enabled:n,lowPowerMode:e,targetFPS:s}){const[o,l]=r.useState(e?"medium":"ultra"),i=r.useRef(s),u=r.useRef(0),a=r.useRef(0),f=r.useMemo(()=>gr[o],[o]);return{qualityTier:o,qualityPreset:f,fpsEstimateRef:i,reportFrame:m=>{if(!Number.isFinite(m)||m<=0)return;const k=1/m,_=.1;i.current=i.current*(1-_)+k*_;const M=s*(e?.74:.72),E=s*(e?.9:.94);if(i.current<M?(u.current+=m,a.current=Math.max(0,a.current-m*.5)):i.current>E?(a.current+=m,u.current=Math.max(0,u.current-m*.5)):(u.current=Math.max(0,u.current-m*.6),a.current=Math.max(0,a.current-m*.6)),u.current>=2.5){u.current=0,a.current=0,l(v=>mn(v,1));return}a.current>=8&&(a.current=0,u.current=0,l(v=>mn(v,-1)))}}}function yr({renderer:n,scene:e,camera:s,initialized:o,lowPowerMode:l,enabled:i=!0}){const u=r.useRef(null);return r.useEffect(()=>{if(!i||!o||!n||!e||!s||l){u.current?.dispose?.(),u.current=null;return}const a=window.innerWidth,f=window.innerHeight,d=new Zn(n),m=new Jn(e,s);d.addPass(m);const k=new Kn(new qn(a,f),.09,.08,.99);d.addPass(k);const _=new er;return d.addPass(_),u.current=d,()=>{d.dispose?.(),u.current=null}},[i,o,n,e,s,l]),r.useEffect(()=>{if(!u.current)return;const a=()=>{const f=window.innerWidth,d=window.innerHeight;u.current?.setSize(f,d)};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]),{composerRef:u}}function br({locale:n}){const e=st[n],s=Ve[n],o=[s.welcome,s.skills,s.about,s.cooperation,s.contacts,s.work],l=`https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(rn)}`;return t.jsxs(qe,{children:[t.jsx(Ge,{children:s.welcome}),t.jsxs(je,{className:"welcome-identity",children:[t.jsx("p",{className:"welcome-identity__role",children:s.personRole}),t.jsx("h3",{className:"welcome-identity__name",children:s.personName})]}),t.jsxs(je,{children:[t.jsx($e,{className:"terminal-typewriter",children:e.hi_title}),t.jsx(pt,{children:e.hi_post_title})]}),t.jsxs("div",{className:"welcome-grid",children:[t.jsxs(je,{className:"nav-menu-block",children:[t.jsx("h3",{className:"nav-menu-title",children:e.hi_nav}),t.jsx(pn,{className:"nav-menu-list",children:o.map((i,u)=>t.jsxs(hn,{children:[t.jsxs("span",{className:"nav-index",children:[u+1,"."]})," ",i]},i))})]}),t.jsxs("aside",{className:"qr-card",children:[t.jsx("div",{className:"qr-orbit",children:t.jsx("img",{src:l,alt:"QR to stekolshchykov.com",loading:"lazy"})}),t.jsx(Tt,{href:rn,target:"_blank",rel:"noreferrer noopener",className:"qr-link",children:"stekolshchykov.com"})]})]})]})}function xr({locale:n}){const e=st[n],s=Ve[n];return t.jsxs(qe,{children:[t.jsx(Ge,{children:s.skills}),t.jsx($e,{children:e.skills_title}),t.jsx(pt,{children:e.skills_post_title}),t.jsxs(je,{children:[t.jsx("h3",{children:e.skills_used_recently}),t.jsx("div",{className:"skill-list",children:Fn.map((o,l)=>t.jsxs("div",{className:"skill-item",children:[t.jsxs("div",{className:"skill-item__head",children:[t.jsx("span",{children:o.name}),t.jsxs("strong",{children:[o.level,"%"]})]}),t.jsx("div",{className:"skill-item__bar",children:t.jsx("div",{style:{width:`${o.level}%`}})})]},`${o.name}-${o.level}-${l}`))})]}),t.jsxs(je,{children:[t.jsx("h3",{children:e.skills_used_before}),t.jsx("div",{className:"skill-list",children:kn.map((o,l)=>t.jsxs("div",{className:"skill-item is-soft",children:[t.jsxs("div",{className:"skill-item__head",children:[t.jsx("span",{children:o.name}),t.jsxs("strong",{children:[o.level,"%"]})]}),t.jsx("div",{className:"skill-item__bar",children:t.jsx("div",{style:{width:`${o.level}%`}})})]},`${o.name}-${o.level}-${l}`))})]})]})}function vr({locale:n}){const e=st[n],s=Ve[n],o=zn(e.about_me_info),l=Pn(e.about_me_info_full);return t.jsxs(qe,{children:[t.jsx(Ge,{children:s.about}),t.jsx($e,{className:"terminal-typewriter",children:e.about_me_title}),t.jsx(pt,{children:e.about_me_post_title}),t.jsxs("div",{className:"about-layout",children:[t.jsx(je,{className:"about-photo-block",children:t.jsx("img",{className:"about-layout__photo",src:"/me-2026.jpg",alt:s.aboutPhotoAlt,loading:"lazy"})}),t.jsxs(je,{className:"terminal-directory",children:[t.jsxs("div",{className:"terminal-row header",children:[t.jsx("span",{className:"col-perms",children:"PERMS"}),t.jsx("span",{className:"col-size",children:"SIZE"}),t.jsx("span",{className:"col-user",children:"USER"}),t.jsx("span",{className:"col-name",children:"NAME"})]}),o.map((i,u)=>t.jsxs("div",{className:"terminal-row",children:[t.jsx("span",{className:"col-perms",children:"drwxr-xr-x"}),t.jsx("span",{className:"col-size",children:"4.0K"}),t.jsx("span",{className:"col-user",children:"root"}),t.jsxs("span",{className:"col-name",children:[t.jsxs("span",{className:"fact-label",children:[i.label,":"]})," ",t.jsx("span",{className:"fact-value",children:i.value})]})]},i.label)),t.jsxs("div",{className:"terminal-row",children:[t.jsx("span",{className:"col-perms",children:"-rw-r--r--"}),t.jsx("span",{className:"col-size",children:"1.2M"}),t.jsx("span",{className:"col-user",children:"root"}),t.jsx("span",{className:"col-name",children:"me-2026.jpg"})]})]})]}),t.jsx(je,{className:"about-text",children:l.map(i=>t.jsx("p",{children:i},i))})]})}function Rr({locale:n}){const e=st[n],s=Ve[n],o=Nn(e.cooperation_text);return t.jsxs(qe,{children:[t.jsx(Ge,{children:s.cooperation}),t.jsx($e,{className:"terminal-typewriter",children:e.cooperation_title}),t.jsx(pt,{children:e.cooperation_post_title}),t.jsx(pn,{className:"cooperation-list",children:o.map((l,i)=>t.jsxs(hn,{className:"cooperation-item",children:[t.jsxs("div",{className:"terminal-row header",children:[t.jsxs("span",{className:"log-id",children:["[LOG_ENTRY_",1e3+i,"]"]}),t.jsx("span",{className:"log-title",children:l.title||"SYSTEM_MSG"})]}),t.jsx("div",{className:"log-body",dangerouslySetInnerHTML:{__html:l.bodyHtml}})]},`${l.title}-${i}`))})]})}function Mr({locale:n}){const e=st[n],s=Ve[n],o=Dn(n),[l,i]=r.useState({email:!1,skype:!1,phone:!1,telegram:!1}),u=[{key:"email",label:s.contactEmail,value:Ue.email,href:`mailto:${Ue.email}`},{key:"phone",label:e.contacts_phone,value:Ue.phone,href:`tel:${Ue.phone}`},{key:"telegram",label:s.contactTelegram,value:Ue.telegram,href:`https://t.me/${Ue.telegram.replace("@","")}`}],a=f=>{ue("info","desktop-contacts","Contact visibility toggled",{key:f,visible:!l[f]}),i(d=>({...d,[f]:!d[f]}))};return t.jsxs(qe,{children:[t.jsx(Ge,{children:s.contacts}),t.jsx($e,{className:"terminal-typewriter",children:e.contacts_title}),t.jsx("div",{className:"contacts-grid",children:u.map(f=>{const d=l[f.key];return t.jsxs(je,{className:"contact-card",children:[t.jsxs("div",{className:"contact-card__head",children:[t.jsx("span",{className:"contact-label",children:f.label}),t.jsx(Cn,{onClick:()=>a(f.key),"aria-label":d?o.hide:o.show,children:d?t.jsx(nr,{size:16}):t.jsx(rr,{size:16})})]}),d?t.jsx(Tt,{href:f.href,target:f.key==="telegram"?"_blank":void 0,rel:"noreferrer",className:"contact-value-link",children:f.value}):t.jsx("p",{className:"contact-hidden",children:An(f.value)})]},f.key)})})]})}function Sr({locale:n}){const e=Ve[n];return t.jsxs(qe,{children:[t.jsx(Ge,{children:e.work}),t.jsx($e,{className:"terminal-typewriter",children:e.workTitle}),t.jsxs("div",{className:"github-feed",children:[t.jsxs(Tt,{className:"github-profile-link",href:Ln,target:"_blank",rel:"noreferrer noopener",children:["@",Tn]}),t.jsx(In,{}),t.jsx("div",{className:"work-grid",children:Wn.map((s,o)=>t.jsxs("a",{href:s.url,target:"_blank",rel:"noreferrer noopener",className:"work-card",children:[t.jsx("span",{className:"work-card__title",children:s.title}),t.jsx("span",{className:"work-card__arrow",children:"â†’"})]},`${s.title}-${o}`))})]})]})}function jr(n){const{locale:e,faceSize:s,facePadding:o,faceDepth:l,cubeSize:i}=n,u=new _n,a=[],f=[],d=new Gn(i,i,i),m=new $n(d),k=new Hn({color:65345,transparent:!0,opacity:0}),_=new Xn(m,k);_.visible=!1;const M=[{component:br,color:"#8b5cf6",position:[0,0,l],rotation:[0,0,0]},{component:xr,color:"#3b82f6",position:[0,0,-l],rotation:[0,Math.PI,0]},{component:vr,color:"#10b981",position:[l,0,0],rotation:[0,Math.PI/2,0]},{component:Rr,color:"#ef4444",position:[-l,0,0],rotation:[0,-Math.PI/2,0]},{component:Mr,color:"#f97316",position:[0,l,0],rotation:[-Math.PI/2,0,0]},{component:Sr,color:"#06b6d4",position:[0,-l,0],rotation:[Math.PI/2,0,0]}];return M.forEach((S,p)=>{const c=document.createElement("div");c.className="cube-face-shell",c.style.width=`${s}px`,c.style.height=`${s}px`,c.style.padding=`${o}px`,c.style.borderRadius="0px",c.style.outline="none",c.style.overflow="hidden",c.style.contain="layout style paint",c.style.willChange="transform";const A=document.createElement("div");A.className="cube-face-scroll",c.appendChild(A),c.addEventListener("wheel",N=>{N.stopPropagation()},{passive:!1});const z=On.createRoot(A);z.render(r.createElement(r.Suspense,{fallback:r.createElement("div",{style:{color:"#cbd5e1",padding:"1rem"}},"Loading...")},r.createElement(S.component,{locale:e}))),f.push(z);const D=new tr(c);D.position.set(S.position[0],S.position[1],S.position[2]),D.rotation.set(S.rotation[0],S.rotation[1],S.rotation[2]),u.add(D);const y=Math.hypot(S.position[0],S.position[1],S.position[2])||1;a.push({object:D,basePosition:[S.position[0],S.position[1],S.position[2]],baseRotation:[S.rotation[0],S.rotation[1],S.rotation[2]],normal:[S.position[0]/y,S.position[1]/y,S.position[2]/y],phase:p*1.37})}),{cubeGroup:u,wireframe:_,faceActors:a,dispose:()=>{d.dispose(),m.dispose(),k.dispose(),f.forEach(S=>{const p=()=>{try{S.unmount()}catch{}};typeof queueMicrotask=="function"?queueMicrotask(p):setTimeout(p,0)})},updateLocale:S=>{M.forEach((p,c)=>{f[c].render(r.createElement(r.Suspense,{fallback:r.createElement("div",{style:{color:"#cbd5e1",padding:"1rem"}},"Loading...")},r.createElement(p.component,{locale:S})))})}}}function Er({scene:n,webglScene:e,locale:s,createConfig:o,isGameMode:l,showCube:i,initialized:u}){const a=r.useRef(null),f=(d,m,k)=>{if(!d)return;const _=!m&&k;d.cubeGroup.visible=_,d.wireframe.visible=!1,d.faceActors.forEach(M=>{const E=M.object.element;E&&(E.style.pointerEvents=_?"auto":"none",_?E.style.display="block":(E.style.opacity="0",E.style.display="none"))}),mt("scene.cube.visibility",{visible:_,gameMode:m})};return r.useEffect(()=>{if(!u||!n||!e)return;const{cubeGroup:d,wireframe:m,faceActors:k,dispose:_,updateLocale:M}=jr({locale:s,...o});return e.add(m),n.add(d),a.current={cubeGroup:d,wireframe:m,faceActors:k,updateLocale:M},mt("scene.cube.created",{locale:s}),f(a.current,l,i),()=>{e.remove(m),n.remove(d),_(),a.current=null}},[u,n,e,o.faceSize,o.facePadding,o.faceAlpha,o.faceDepth,o.cubeSize,o.isPhone,o.lowPowerMode,i]),r.useEffect(()=>{f(a.current,l,i)},[l,i]),r.useEffect(()=>{a.current?.updateLocale&&a.current.updateLocale(s)},[s]),a}const Fr=!0;function Dr({targetRotation:n,locale:e,onReady:s,isGameMode:o=!1,joystickInput:l={x:0,y:0},lookJoystickInput:i={x:0,y:0},withSingularityBackground:u=!1,navigationTrigger:a=0,activeFaceId:f,onActiveFaceChange:d}){const m=r.useRef(null),k=r.useRef(null),_=r.useRef(null),M=r.useRef(!1),E=r.useRef(o),v=r.useRef(-1),S=r.useRef(!1);r.useRef(!1);const p=r.useRef(d),c=r.useRef(f),A=r.useRef(s);r.useEffect(()=>{p.current=d},[d]),r.useEffect(()=>{c.current=f},[f]),r.useEffect(()=>{A.current=s},[s]);const z=window.innerWidth,D=window.matchMedia("(prefers-reduced-motion: reduce)").matches,y=z<700,N=z<1100,$=navigator.hardwareConcurrency>0&&navigator.hardwareConcurrency<=4,g=D||y&&$,C=g?1:2.1,H=g?24:60,ae=g?6:10,J=g?.76:.82,R=g?.1:.14,L=!0,G=y?420:N?620:860,B=y?14:N?20:28,b=g?.72:.5,X=Math.round(G*.58),ee=X*2,x=50,ht=G*.5,_t=x*Math.PI/180,He=ht/Math.tan(_t/2),Ce=Math.max(y?1200:N?1400:1600,He+X*.8),Ae=Ce,Y=Ce,O=()=>_.current?.(),te=r.useRef(0),fe=r.useRef(0),he=r.useRef(new F),_e=r.useRef(!1),ot=r.useRef(l),it=r.useRef(i);r.useEffect(()=>{ot.current=l},[l]),r.useEffect(()=>{it.current=i},[i]),r.useEffect(()=>{E.current=o},[o]);const{sceneRef:gt,webglSceneRef:Xe,cameraRef:ge,cssRendererRef:Lt,webglRendererRef:Qe,initialized:De}=mr({pixelRatio:C,isPhone:y,isTablet:N,containerRef:m,webglContainerRef:k}),{updateStarField:wt,applyQuality:It}=pr({sceneRef:Xe,lowPowerMode:g,initialized:De,enabled:!u}),{composerRef:Wt}=yr({renderer:Qe.current,scene:Xe.current,camera:ge.current,initialized:De,lowPowerMode:g,enabled:!u}),yt=r.useRef(!1),Ze=r.useRef(null),Je=r.useRef(null),me=r.useRef(null);r.useEffect(()=>{fr().then(j=>{Ze.current=j.memory,yt.current=!0}).catch(j=>{ue("error","scene.wasm","Failed to init Wasm",j)})},[]);const we=Er({scene:gt.current,webglScene:Xe.current,locale:e,createConfig:{faceSize:G,facePadding:B,faceAlpha:b,faceDepth:X,cubeSize:ee,isPhone:y,lowPowerMode:g},isGameMode:o,showCube:Fr,initialized:De});r.useEffect(()=>{if(yt.current&&De&&!Je.current){const j=Math.floor((g?1700:4200)*1),ne=g?2e3:2900;Je.current=new Dt(j,ne)}},[De,g]),r.useEffect(()=>{if(yt.current&&we.current&&!me.current){const j=we.current.faceActors,ne=new Float32Array(j.length*3),ye=new Float32Array(j.length*3),be=new Float32Array(j.length*3),Te=new Float32Array(j.length);j.forEach((xe,ve)=>{ne.set(xe.normal,ve*3),ye.set(xe.basePosition,ve*3),be.set(xe.baseRotation,ve*3),Te[ve]=xe.phase}),me.current=new At(ne,ye,be,Te)}},[we]);const{qualityTier:Ot,qualityPreset:Q,reportFrame:Ut}=wr({enabled:!0,lowPowerMode:g,targetFPS:H}),{currentRotationRef:oe,targetRotationRef:Ee,velocityRef:Ke,inertiaRef:bt,userCameraDistanceRef:Bt,isDraggingRef:at,isTransitioningRef:xt,updatePhysics:Yt}=hr({interactionTargetRef:m,minZoom:Ae,maxZoom:Y,defaultCameraDistance:Ce,startAnimation:O});r.useEffect(()=>{o&&sn(async()=>{const{TelemetryLogger:j}=await import("./TelemetryLogger-D_MlReo8.js");return{TelemetryLogger:j}},[],import.meta.url).then(({TelemetryLogger:j})=>{j.getInstance().start()})},[o]),r.useEffect(()=>{It({starDensity:u?0:Q.starDensity,starTwinkle:Q.starTwinkle});const j=Qe.current;j&&j.setPixelRatio(Math.min(window.devicePixelRatio,C*Q.pixelRatioScale)),mt("scene.performance.mode",{qualityTier:Ot},"debug")},[It,C,Q,Ot,Qe]),r.useEffect(()=>{if(ge.current)if(o){const j=ge.current,ne=new F;j.getWorldDirection(ne);const ye=Math.max(-.999,Math.min(.999,ne.y));te.current=Math.atan2(ne.x,ne.z),fe.current=Math.asin(ye),he.current.copy(j.position),_e.current=!0}else _e.current=!1},[ge,o]),r.useEffect(()=>{typeof window<"u"&&(window.__getCameraRotation=()=>{if(ge.current){const{x:j,y:ne,z:ye}=ge.current.rotation,be=ge.current.position;return{rotation:{x:j,y:ne,z:ye},position:{x:be.x,y:be.y,z:be.z}}}return null})},[]),r.useEffect(()=>{!at.current&&Ee.current!==n&&(Ee.current=n)},[n,Ee]),r.useEffect(()=>{a>0&&(Ee.current=n,bt.current.x=0,bt.current.y=0,ue("info","scene3d-nav","Forced navigation trigger applies",{targetRotation:n}))},[a,n,bt]);const{updateCameraFlight:Vt,rotationBurstRef:ct,cameraFlightRef:qt}=_r({targetRotation:n,minZoom:Ae,maxZoom:Y,isPhone:y,lowPowerMode:g,prefersReducedMotion:D,startAnimation:O,defaultCameraDistance:Ce,lockCamera:L});return r.useEffect(()=>{if(!De)return;let j=0,ne=0,ye=!1;const be=1e3/H,Te=new F,xe=new F,ve=new F,lt=new F,Gt=new F,gn=new F(0,1,0),wn=new F,ut=new F,Ie=new F,$t=new F,vt=new F,Rt=new F,Ht=new F,Re=new F;let Xt=!1,Qt=!1;const We=["welcome","skills","about","cooperation","contacts","work"],Zt=Fe=>{j=0;const yn=Ee.current.x-oe.current.x,bn=Ee.current.y-oe.current.y,et=E.current,Mt=ot.current,St=it.current,xn=et&&(Math.abs(Mt.x)>.01||Math.abs(Mt.y)>.01||Math.abs(St.x)>.01||Math.abs(St.y)>.01),vn=at.current||qt.current.active||ct.current.active||Math.abs(yn)>6e-4||Math.abs(bn)>6e-4||Math.abs(Ke.current.x)>2e-4||Math.abs(Ke.current.y)>2e-4||xn;if(g&&ye&&!vn)return;j=requestAnimationFrame(Zt);const jt=Fe-ne;if(jt<be)return;ne=Fe-jt%be;const de=jt/1e3;Ut(de);const P=ge.current;let I=v.current;et?P&&sn(async()=>{const{TelemetryLogger:T}=await import("./TelemetryLogger-D_MlReo8.js");return{TelemetryLogger:T}},[],import.meta.url).then(({TelemetryLogger:T})=>{T.getInstance().logFrame(Mt,St,P,et)}):Yt(g,de);const tt=Math.sin(Fe*35e-5)*ae;we.current&&we.current.cubeGroup.visible&&(we.current.cubeGroup.position.y=tt,we.current.wireframe.position.y=tt);let Et=null,Ft=null;if(et&&P){const T=P,ce=g?55:75,le=g?4.2:7,ze=ot.current.x,Z=ot.current.y,V=it.current.x,re=it.current.y;if(!_e.current){const U=new F;T.getWorldDirection(U);const K=Math.max(-.999,Math.min(.999,U.y));te.current=Math.atan2(U.x,U.z),fe.current=Math.asin(K),he.current.copy(T.position),_e.current=!0}const ie=Math.max(de,1/120)*1.4;te.current+=V*le*ie,fe.current+=re*le*ie,fe.current=Math.max(-1.2,Math.min(1.2,fe.current));const W=Math.cos(fe.current);lt.set(Math.sin(te.current)*W,Math.sin(fe.current),Math.cos(te.current)*W).normalize(),Gt.crossVectors(lt,gn).normalize(),Ie.set(0,0,0),Ie.addScaledVector(lt,Z),Ie.addScaledVector(Gt,ze),Ie.lengthSq()>1e-4&&Ie.normalize(),he.current.addScaledVector(Ie,ce*de),Et=he.current,Ft=wn.copy(he.current).addScaledVector(lt,200)}let pe=0,ke=0,Oe=0;if(P)if(et&&Et&&Ft)P.position.copy(Et),P.lookAt(Ft),P.rotation.z=0;else{const T=new F(0,tt,0),ce=Vt(Fe,Bt.current,tt,T,Q.motionScale)||{},{cameraDistance:le=1500,cameraYaw:ze=0,cameraPitch:Z=0,cameraRoll:V=0,cameraOverridePosition:re=null,lookAtOverride:ie=null}=ce;pe=ce.flightEnvelope??0,ke=ce.flightSwirl??0,Oe=ce.burst??0;const W=0,U=Math.sin(ze)*W,K=Math.sin(Z)*W*.42,Pe=Math.cos(ze)*W*.16,Me=ie??T;if(re?ut.copy(re):ut.set(U,tt+K,le+Pe),!Xt)Xt=!0,vt.copy(ut),Rt.copy(Me);else{const se=Math.min(1,Math.max(.06,1-Math.exp(-de*6.6)));vt.lerp(ut,se),Rt.lerp(Me,se*.9)}P.position.copy(vt),P.lookAt(Rt),P.rotation.z=V*Q.motionScale;let w=0;Qt?w=P.position.distanceTo($t)/Math.max(de,1/240):Qt=!0,$t.copy(P.position);const q=Math.hypot(Ke.current.x,Ke.current.y)/Math.max(de,1/240)*(g?1600:2600);!u&&Je.current&&Ze.current?(Je.current.update(de,w,q),wt(de,P.position,pe,w+q,Je.current,Ze.current)):u||wt(de,P.position,pe,w+q)}if(we.current&&P&&P.position){const{cubeGroup:T,wireframe:ce,faceActors:le}=we.current;if(me.current&&Ze.current){me.current.rotation_x=oe.current.x,me.current.rotation_y=oe.current.y,me.current.flight_envelope=pe,me.current.flight_swirl=ke,me.current.burst=Oe,me.current.update(de,at.current,Ee.current.x,Ee.current.y,xt.current,Q.motionScale,ee,new Float32Array([P.position.x,P.position.y,P.position.z]),new Float32Array([T.position.x,T.position.y,T.position.z]),ct.current.seed);const Z=Math.sin(ke*1.2)*.014*pe*Q.motionScale,V=Math.cos(ke*.95)*.022*pe*Q.motionScale,re=Math.sin(ke*1.55)*.012*pe*Q.motionScale;T.rotation.set(oe.current.x+Z,oe.current.y+V,re),ce.rotation.set(oe.current.x+Z*1.06,oe.current.y+V*1.06,re*1.1);const ie=me.current.get_face_matrices_ptr(),W=new Float32Array(Ze.current.buffer,ie,96);T.getWorldPosition(Te),xe.copy(P.position).sub(Te).normalize();let U=-1,K=-1;le.forEach((w,Se)=>{const q=Se*16,se=W[q+0],kt=W[q+1],zt=W[q+2],Rn=W[q+3],Mn=W[q+4],Sn=W[q+5];w.object.position.set(se,kt,zt),w.object.rotation.set(Rn,Mn,Sn),ve.set(w.normal[0],w.normal[1],w.normal[2]).applyQuaternion(T.quaternion).normalize();const Pt=Math.max(0,ve.dot(xe));Pt>U&&(U=Pt,K=Se);const jn=Math.pow(Pt,1.6),En=R+(J-R)*jn;w.object.element.style.opacity=En.toFixed(3)});const Pe=g?.62:.56,Me=g?.44:.4;if(K===-1?I=-1:v.current===-1?I=U>=Pe?K:-1:U<Me?I=-1:I=K,I!==v.current){if(v.current>=0&&le[v.current]?.object.element.classList.remove("cube-face-shell--active"),I>=0){const w=le[I]?.object.element;w&&w.classList.add("cube-face-shell--active")}v.current=I}}else{let Z=-1,V=-1;const re=Math.sin(ke*1.2)*.014*pe*Q.motionScale,ie=Math.cos(ke*.95)*.022*pe*Q.motionScale,W=Math.sin(ke*1.55)*.012*pe*Q.motionScale;T.rotation.x=oe.current.x+re,T.rotation.y=oe.current.y+ie,T.rotation.z=W,ce.rotation.x=oe.current.x+re*1.06,ce.rotation.y=oe.current.y+ie*1.06,ce.rotation.z=W*1.1;const U=ee*(g?.045:.09)*Oe*Q.motionScale,K=(g?.0026:.0054)*Oe*Q.motionScale;T.getWorldPosition(Te),xe.copy(P.position).sub(Te).normalize(),le.forEach((w,Se)=>{const q=Math.sin(Fe*.009+w.phase+ct.current.seed)*ee*.007*Oe;w.object.position.set(w.basePosition[0]+w.normal[0]*(U+q),w.basePosition[1]+w.normal[1]*(U+q),w.basePosition[2]+w.normal[2]*(U+q)),w.object.rotation.set(w.baseRotation[0]+Math.sin(Fe*.011+w.phase)*K,w.baseRotation[1]+Math.cos(Fe*.01+w.phase)*K,w.baseRotation[2]+Math.sin(Fe*.012+w.phase)*K*.65),ve.set(w.normal[0],w.normal[1],w.normal[2]).applyQuaternion(T.quaternion).normalize();const se=Math.max(0,ve.dot(xe));se>Z&&(Z=se,V=Se);const kt=Math.pow(se,1.6),zt=R+(J-R)*kt;w.object.element.style.opacity=zt.toFixed(3)});const Pe=g?.62:.56,Me=g?.44:.4;if(V===-1?I=-1:v.current===-1?I=Z>=Pe?V:-1:Z<Me?I=-1:I=V,I!==v.current){if(v.current>=0&&le[v.current]?.object.element.classList.remove("cube-face-shell--active"),I>=0){const w=le[I]?.object.element;w&&w.classList.add("cube-face-shell--active")}v.current=I}}if(I!==-1){const Z=We[I],V={up:Z,down:Z,left:Z,right:Z};let re=-1,ie=-1,W=-1,U=-1,K=.1,Pe=.1,Me=.1,w=.1;le.forEach((q,se)=>{se!==I&&(Ht.set(q.normal[0],q.normal[1],q.normal[2]).applyQuaternion(T.quaternion),P&&(Re.copy(Ht).transformDirection(P.matrixWorldInverse),Re.y>K&&(K=Re.y,re=se),Re.y<-Pe&&(Pe=-Re.y,ie=se),Re.x<-Me&&(Me=-Re.x,W=se),Re.x>w&&(w=Re.x,U=se)))}),re!==-1&&(V.up=We[re]),ie!==-1&&(V.down=We[ie]),W!==-1&&(V.left=We[W]),U!==-1&&(V.right=We[U]);const Se=We[I];Se&&(!xt.current||Se===c.current?p.current?.(Se,V):p.current?.(c.current,V))}S.current=!!xt.current;const ze=1+Oe*.06;ce.scale.set(ze,ze,ze)}const Kt=gt.current,en=Xe.current,tn=Lt.current,nn=Qe.current;Kt&&P&&tn&&tn.render(Kt,P),en&&P&&nn&&(Wt.current?Wt.current.render():nn.render(en,P)),M.current||(M.current=!0,A.current?.()),ye=!0};_.current=()=>{j===0&&(j=requestAnimationFrame(Zt))},_.current();const Jt=()=>{j===0&&_.current?.()};return window.addEventListener("resize",Jt),()=>{cancelAnimationFrame(j),window.removeEventListener("resize",Jt),j=0,_.current=null}},[De,H,g,ae,ee,J,R,D,Yt,Vt,wt,Ut,Q,qt,ge,Lt,oe,at,ct,gt,Bt,Ke,Qe,Xe,s,u]),t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:k,"data-testid":"scene-webgl",style:{position:"absolute",inset:0,zIndex:1}}),t.jsx("div",{ref:m,"data-testid":"scene-css3d",style:{position:"absolute",inset:0,zIndex:2}})]})}export{Dr as Scene3D};
